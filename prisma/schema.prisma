generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- HỆ THỐNG ĐƠN VỊ ---

model LeadSetting {
  id        String   @id @default("lead_config")
  hotDays   Int      @default(3) // Ví dụ: dưới 3 ngày là Hot
  warmDays  Int      @default(7) // Ví dụ: từ 3 - 7 ngày là Warm
  // Cool sẽ là trên warmDays
  updatedAt DateTime @updatedAt
}

enum UrgencyType {
  HOT
  WARM
  COOL
}

enum OriginType {
  VN
  TH
  ID
  OTHER
}

enum OwnerType {
  PERSONAL // Chính chủ
  AUTHORIZATION_L1 // Ủy quyền lần 1
  AUTHORIZATION_L2 // Ủy quyền lần 2
  COMPANY_VAT // Công ty / Xuất hóa đơn
}

model Branch {
  id             String          @id @default(cuid())
  name           String          @unique // Tên chi nhánh (VD: Toyota Bình Dương)
  address        String // Địa chỉ chi nhánh
  cars           Car[] // Danh sách xe thuộc chi nhánh
  users          User[] // Nhân viên thuộc chi nhánh
  salesSchedules SalesSchedule[]
}

model Department {
  id        String     @id @default(cuid())
  name      String     @unique // Tên phòng ban (VD: Phòng Thu Mua, Phòng Kinh Doanh)
  positions Position[] // Các chức vụ trong phòng này
  users     User[] // Các nhân viên thuộc phòng này
  createdAt DateTime   @default(now())
}

model Position {
  id           String     @id @default(cuid())
  name         String // Tên chức vụ (VD: Trưởng phòng, Nhân viên)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  users        User[]

  @@unique([name, departmentId]) // Đảm bảo tên chức vụ trong 1 phòng không trùng nhau
}

model CarModel {
  id        String     @id @default(cuid())
  name      String     @unique
  customers Customer[] // Quan hệ ngược lại
  grade     String? // Mã xe (A, B, C, D...)
  cars      Car[] // Dùng cho cả bảng xe trong kho
}

// --- HỆ THỐNG NGƯỜI DÙNG ---

model User {
  id       String  @id @default(cuid())
  username String  @unique // Mã nhân viên dùng để đăng nhập
  fullName String? // Họ tên đầy đủ
  email    String  @unique // Email công ty
  password String // Mật khẩu đã hash
  phone    String? // Số điện thoại nhân viên
  role     Role    @default(REFERRER) // Quyền hệ thống (ADMIN, MANAGER, ...)
  active   Boolean @default(true) // Trạng thái tài khoản

  // --- QUAN HỆ ĐƠN VỊ ---
  branchId     String?
  branch       Branch?     @relation(fields: [branchId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  positionId   String?
  position     Position?   @relation(fields: [positionId], references: [id])

  // --- CẤU HÌNH TỔNG ĐÀI ---
  extension       String? // Số máy lẻ
  extensionPwd    String? // Mật khẩu máy lẻ
  isGlobalManager Boolean @default(false) // Quản lý toàn hệ thống

  // --- QUAN HỆ NGHIỆP VỤ VỚI XE (CAR) ---
  purchases      Car[] @relation("Purchaser") // Xe nhân viên này trực tiếp đi thu mua
  negotiatedCars Car[] @relation("PriceNegotiator") // Xe nhân viên này đứng ra đàm phán giá
  referrals      Car[] @relation("Referrer") // Xe do nhân viên này giới thiệu nguồn

  // --- QUAN HỆ VỚI KHÁCH HÀNG (CUSTOMER/LEADS) ---
  createdReferrals Customer[] @relation("CreatedReferrals") // Khách do nhân viên này nhập lên hệ thống
  assignedLeads    Customer[] @relation("AssignedLeads") // Khách được giao cho nhân viên này chăm sóc

  // --- THEO DÕI HOẠT ĐỘNG ---
  lastAssignedAt DateTime?       @default(now()) // Dùng để xoay vòng chia khách (Round Robin)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  leadActivities LeadActivity[]
  cars           Car[]
  salesSchedules SalesSchedule[]

  @@index([branchId], map: "User_branchId_fkey")
}

// --- HỆ THỐNG QUẢN LÝ XE ---

model Car {
  id String @id @default(cuid())

  // --- THÔNG TIN ĐỊNH DANH CƠ BẢN ---
  modelName    String
  vin          String
  engineNumber String?
  licensePlate String?
  year         Int
  stockCode    String  @unique

  // --- THÔNG SỐ KỸ THUẬT CHI TIẾT ---
  odo           Int
  transmission  Transmission @default(AUTOMATIC)
  fuelType      FuelType     @default(GASOLINE)
  carType       CarType      @default(SUV)
  engineSize    String?
  driveTrain    String?
  color         String?
  interiorColor String?
  seats         Int          @default(5)
  origin        OriginType   @default(VN)
  ownerType     OwnerType    @default(PERSONAL)

  // --- BỔ SUNG TRƯỜNG MỚI THEO YÊU CẦU ---
  authorizedOwnerName  String? // Người đứng ủy quyền (Tên cá nhân/pháp nhân)
  registrationDeadline DateTime? // Thời hạn đăng kiểm
  insuranceDeadline    DateTime? // Bảo hiểm (Thời hạn bảo hiểm dân sự/thân vỏ)
  warrantyDeadline     DateTime? // Thời gian bảo hành (Đến ngày nào)

  // --- QUAN HỆ NHÂN VIÊN XỬ LÝ ---
  purchaserId String?
  purchaser   User?   @relation("Purchaser", fields: [purchaserId], references: [id]) // Nhân viên thu mua

  priceNegotiatorId String?
  priceNegotiator   User?   @relation("PriceNegotiator", fields: [priceNegotiatorId], references: [id]) // Nhân viên deal giá

  // ---------------------------------------

  isPublished Boolean   @default(false)
  displayDate DateTime?

  // --- THÔNG TIN THƯƠNG MẠI ---
  sellingPrice  Decimal? @db.Decimal(15, 2)
  costPrice     Decimal? @db.Decimal(15, 2)
  isPromoted    Boolean  @default(false)
  promotionNote String?  @db.Text

  // --- NỘI DUNG HIỂN THỊ (CMS) ---
  images      Json?
  videoUrl    String?
  description String? @db.Text
  features    String? @db.Text

  // --- TRẠNG THÁI & QUẢN LÝ ---
  status   CarStatus @default(PENDING)
  branchId String
  branch   Branch    @relation(fields: [branchId], references: [id])

  // Quan hệ nhân sự khác
  referrerId String
  referrer   User   @relation("Referrer", fields: [referrerId], references: [id])

  // --- THỜI GIAN ---
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  purchasedAt   DateTime?
  refurbishedAt DateTime?
  soldAt        DateTime?
  carModel      CarModel? @relation(fields: [carModelId], references: [id])
  carModelId    String?

  ownerHistory CarOwnerHistory[]
  user         User?             @relation(fields: [userId], references: [id])
  userId       String?

  @@index([branchId])
  @@index([purchaserId])
  @@index([priceNegotiatorId]) // Thêm index cho nhân viên deal giá
  @@index([referrerId])
  @@index([status])
  @@index([stockCode])
}

// --- BỔ SUNG CÁC ENUM ĐỂ CHUẨN HÓA DỮ LIỆU ---

enum Transmission {
  MANUAL // Số sàn
  AUTOMATIC // Số tự động
  CVT // Số vô cấp
}

enum FuelType {
  GASOLINE // Xăng
  DIESEL // Dầu
  HYBRID // Xăng pha điện
  ELECTRIC // Điện
}

enum CarType {
  SEDAN
  SUV
  HATCHBACK
  PICKUP // Bán tải
  MPV // Xe đa dụng (Vd: Innova)
  COUPE
}

// --- HỆ THỐNG QUẢN LÝ KHÁCH HÀNG (LEADS) ---

model Customer {
  id       String       @id @default(cuid())
  fullName String // Tên khách hàng
  phone    String // Số điện thoại khách
  type     ReferralType @default(SELL) // Nhu cầu: Bán/Mua/Định giá
  status   LeadStatus   @default(NEW) // Trạng thái xử lý

  // --- CÁC TRƯỜNG BỔ SUNG TỪ GIAO DIỆN ---
  carYear       String? // Loại xe (Vd: Vios, Fortuner...)
  licensePlate  String? // Biển số xe (Dành cho Bán xe & Định giá)
  budget        String? // Ngân sách (Dành cho Mua xe)
  expectedPrice String? // Giá mong muốn (Dành cho Định giá)

  assignedAt     DateTime? // Thời điểm bàn giao khách cho NV
  firstContactAt DateTime? // Thời điểm thực hiện cuộc gọi/liên hệ đầu tiên
  lastContactAt  DateTime? // Lần liên hệ gần nhất
  nextContactAt  DateTime? // Lần liên hệ tiếp theo (Hẹn gọi lại)
  urgencyLevel   UrgencyType? // Lưu trạng thái Hot/Warm/Cool lúc mới tiếp cận

  isPublished Boolean   @default(false) // Admin tích vào đây xe mới hiện lên web
  displayDate DateTime? // Ngày bắt đầu cho hiện showroom (để sort xe mới về)

  // Lưu trữ link hình ảnh (sau khi upload lên Cloudinary/S3)
  carImages         String? @db.Text // JSON string hoặc danh sách link ảnh xe
  registrationImage String? @db.Text // Ảnh đăng kiểm
  idCardFront       String? @db.Text // Ảnh giấy tờ mặt trước
  idCardBack        String? @db.Text // Ảnh giấy tờ mặt sau

  carModelId String?
  carModel   CarModel? @relation(fields: [carModelId], references: [id])

  note String? @db.Text // Ghi chú chi tiết thêm
  // ---------------------------------------

  // Người giới thiệu khách (Referrer)
  referrerId String
  referrer   User   @relation("CreatedReferrals", fields: [referrerId], references: [id])

  // Nhân viên được giao chăm sóc
  assignedToId String?
  assignedTo   User?   @relation("AssignedLeads", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activities        LeadActivity[]
  carOwnerHistories CarOwnerHistory[]

  // Thêm index cho status để tăng tốc độ truy vấn khi lọc khách hàng
  @@index([status])
  @@index([referrerId])
  @@index([assignedToId])
}

model LeadActivity {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  status LeadStatus // Trạng thái tại thời điểm cập nhật

  // Liên kết đến lý do mẫu từ Admin
  reasonId String?
  reason   LeadReason? @relation(fields: [reasonId], references: [id])

  // Ghi chú thêm của nhân viên (không bắt buộc)
  note String? @db.Text

  createdById String
  user        User     @relation(fields: [createdById], references: [id]) // Tên quan hệ ở đây
  createdAt   DateTime @default(now())

  @@index([customerId])
  @@index([reasonId])
}

model LeadReason {
  id         String         @id @default(cuid())
  content    String         @unique // Nội dung lý do (VD: Khách chê giá thu thấp)
  type       LeadStatus // Thuộc nhóm trạng thái nào (LOSE, FROZEN, PENDING_VIEW)
  active     Boolean        @default(true) // Cho phép sử dụng hay ẩn đi
  activities LeadActivity[] // Quan hệ ngược lại để truy xuất thống kê
  createdAt  DateTime       @default(now())
}

model SalesSchedule {
  id       String   @id @default(cuid())
  date     DateTime
  branchId String
  branch   Branch   @relation(fields: [branchId], references: [id])
  userId   String
  user     User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  // Bỏ @unique cũ, thay bằng index để truy vấn nhanh
  @@index([date, branchId])
}

// --- ENUMS (DANH MỤC CỐ ĐỊNH) ---

enum Role {
  ADMIN // Quản trị hệ thống
  MANAGER // Quản lý chi nhánh/phòng ban
  PURCHASE_STAFF // Nhân viên thu mua (Định giá/Mua xe)
  SALES_STAFF // Nhân viên kinh doanh (Bán xe)
  REFERRER // Người giới thiệu (Cộng tác viên/NV các phòng khác)
}

enum ReferralType {
  SELL // Khách hàng muốn bán/đổi xe
  BUY // Khách hàng muốn tìm mua xe cũ
  VALUATION // Khách hàng chỉ muốn định giá xe
}

enum LeadStatus {
  NEW // Mới tiếp nhận từ người giới thiệu
  ASSIGNED // Đã phân bổ cho nhân viên chăm sóc
  CONTACTED // Đã liên hệ trao đổi với khách
  DEAL_DONE // Đã giao dịch thành công (Mua hoặc Bán)
  CANCELLED // Khách không còn nhu cầu hoặc sai thông tin
  PENDING_DEAL_APPROVAL // Chờ duyệt Thu mua/Bán thành công
  PENDING_LOSE_APPROVAL // Chờ duyệt Thất bại

  LOSE // Thất bại hoàn toàn
  FROZEN // Đóng băng (Tạm dừng chăm sóc)
  PENDING_VIEW // Nguyên nhân chưa xem xe được
}

enum CarStatus {
  NEW
  PENDING // Đang chờ kiểm tra/định giá
  PURCHASE_FAILED // Không mua được xe
  REFURBISHING // Đang trong quá trình làm đẹp (Maru-Kuri)
  READY_FOR_SALE // Đã sẵn sàng trưng bày bán
  BOOKED // Khách đã đặt cọc
  SOLD // Đã bàn giao xe cho khách
}

model CarOwnerHistory {
  id         String   @id @default(cuid())
  carId      String
  car        Car      @relation(fields: [carId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  type       String // "PURCHASE" (Mua vào) hoặc "SALE" (Bán ra)
  contractNo String?
  price      Decimal  @db.Decimal(15, 2)
  date       DateTime @default(now())
  note       String?
}
