generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- HỆ THỐNG ĐƠN VỊ ---

model LeadSetting {
  id        String   @id @default("lead_config")
  hotDays   Int      @default(3) // Ví dụ: dưới 3 ngày là Hot
  warmDays  Int      @default(7) // Ví dụ: từ 3 - 7 ngày là Warm
  // Cool sẽ là trên warmDays
  updatedAt DateTime @updatedAt
}

enum UrgencyType {
  HOT
  WARM
  COOL
}

enum OwnerType {
  PERSONAL // Xe cá nhân
  COMPANY // Xe công ty (Có xuất hóa đơn VAT)
}

model Branch {
  id      String @id @default(cuid())
  name    String @unique // Tên chi nhánh (VD: Toyota Bình Dương)
  address String // Địa chỉ chi nhánh
  cars    Car[] // Danh sách xe thuộc chi nhánh
  users   User[] // Nhân viên thuộc chi nhánh
}

model Department {
  id        String     @id @default(cuid())
  name      String     @unique // Tên phòng ban (VD: Phòng Thu Mua, Phòng Kinh Doanh)
  positions Position[] // Các chức vụ trong phòng này
  users     User[] // Các nhân viên thuộc phòng này
  createdAt DateTime   @default(now())
}

model Position {
  id           String     @id @default(cuid())
  name         String // Tên chức vụ (VD: Trưởng phòng, Nhân viên)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  users        User[]

  @@unique([name, departmentId]) // Đảm bảo tên chức vụ trong 1 phòng không trùng nhau
}

model CarModel {
  id        String     @id @default(cuid())
  name      String     @unique
  customers Customer[] // Quan hệ ngược lại
  grade     String? // Mã xe (A, B, C, D...)
  cars      Car[] // Dùng cho cả bảng xe trong kho
}

// --- HỆ THỐNG NGƯỜI DÙNG ---

model User {
  id       String  @id @default(cuid())
  username String  @unique // Mã nhân viên dùng để đăng nhập
  fullName String? // Họ tên đầy đủ
  email    String // Email công ty
  password String // Mật khẩu đã hash
  phone    String? // Số điện thoại nhân viên
  role     Role    @default(REFERRER) // Quyền hệ thống
  active   Boolean @default(true) // Trạng thái tài khoản

  // Quan hệ đơn vị
  branchId     String?
  branch       Branch?     @relation(fields: [branchId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  positionId   String?
  position     Position?   @relation(fields: [positionId], references: [id])

  // Cấu hình tổng đài (Nếu có)
  extension       String? @unique
  extensionPwd    String?
  isGlobalManager Boolean @default(false) // Quản lý toàn hệ thống

  // Quan hệ nghiệp vụ
  purchases        Car[]          @relation("Purchaser") // Xe do nhân viên này thu mua
  referrals        Car[]          @relation("Referrer") // Xe do nhân viên này giới thiệu
  createdReferrals Customer[]     @relation("CreatedReferrals") // Khách hàng do nhân viên này giới thiệu
  assignedLeads    Customer[]     @relation("AssignedLeads") // Khách hàng được giao cho nhân viên này chăm sóc
  lastAssignedAt   DateTime?      @default(now()) // Dùng để sắp xếp người nào đợi lâu nhất thì nhận khách
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  leadActivities   LeadActivity[]

  @@index([branchId], map: "User_branchId_fkey")
}

// --- HỆ THỐNG QUẢN LÝ XE ---

model Car {
  id String @id @default(cuid())

  // --- THÔNG TIN ĐỊNH DANH CƠ BẢN ---
  modelName    String // VD: Toyota Fortuner 2.8AT 4x4 Legender
  vin          String // Số khung (Dùng để kiểm tra lịch sử bảo dưỡng)
  engineNumber String? // Số máy
  licensePlate String? // Biển kiểm soát (Có thể ẩn 2 số cuối khi hiển thị web)
  year         Int // Năm sản xuất

  // --- THÔNG SỐ KỸ THUẬT CHI TIẾT ---
  odo           Int // Số Km đã đi
  transmission  Transmission @default(AUTOMATIC) // Hộp số
  fuelType      FuelType     @default(GASOLINE) // Loại nhiên liệu
  carType       CarType      @default(SUV) // Kiểu dáng xe
  engineSize    String? // Dung tích động cơ (VD: 2.8L)
  driveTrain    String? // Hệ dẫn động (VD: 4WD, RWD, FWD)
  color         String? // Màu ngoại thất
  interiorColor String? // Màu nội thất
  seats         Int          @default(5) // Số chỗ ngồi
  origin        String? // Xuất xứ (VD: Nhập khẩu Thái Lan, Lắp ráp trong nước)
  ownerType     OwnerType    @default(PERSONAL) // Xe cá nhân hay công ty

  // --- THÔNG TIN THƯƠNG MẠI ---
  sellingPrice  Decimal? @db.Decimal(15, 2) // Giá niêm yết trên Web
  costPrice     Decimal? @db.Decimal(15, 2) // Giá gốc thu mua (Chỉ Admin xem)
  isPromoted    Boolean  @default(false) // Đánh dấu xe đang giảm giá/khuyến mãi
  promotionNote String?  @db.Text // Chi tiết quà tặng kèm theo

  // --- NỘI DUNG HIỂN THỊ (CMS) ---
  images      Json? // Lưu danh sách URL ảnh (Dạng mảng: ["url1", "url2"])
  videoUrl    String? // Link Youtube/TikTok review xe
  description String? @db.Text // Mô tả chi tiết tình trạng xe (Cam kết 5 tiêu chuẩn vàng)
  features    String? @db.Text // Các tính năng nổi bật (VD: Phanh tay điện tử, Cửa sổ trời...)

  // --- TRẠNG THÁI & QUẢN LÝ ---
  status   CarStatus @default(PENDING)
  branchId String
  branch   Branch    @relation(fields: [branchId], references: [id])

  // Quan hệ nhân sự
  referrerId  String
  referrer    User    @relation("Referrer", fields: [referrerId], references: [id])
  purchaserId String?
  purchaser   User?   @relation("Purchaser", fields: [purchaserId], references: [id])

  // --- THỜI GIAN ---
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  purchasedAt   DateTime? // Ngày ký hợp đồng mua về
  refurbishedAt DateTime? // Ngày hoàn tất làm đẹp (Maru-Kuri)
  soldAt        DateTime? // Ngày giao xe cho khách
  carModel      CarModel? @relation(fields: [carModelId], references: [id])
  carModelId    String?

  ownerHistory CarOwnerHistory[]

  @@index([branchId])
  @@index([purchaserId])
  @@index([referrerId])
  @@index([status])
}

// --- BỔ SUNG CÁC ENUM ĐỂ CHUẨN HÓA DỮ LIỆU ---

enum Transmission {
  MANUAL // Số sàn
  AUTOMATIC // Số tự động
  CVT // Số vô cấp
}

enum FuelType {
  GASOLINE // Xăng
  DIESEL // Dầu
  HYBRID // Xăng pha điện
  ELECTRIC // Điện
}

enum CarType {
  SEDAN
  SUV
  HATCHBACK
  PICKUP // Bán tải
  MPV // Xe đa dụng (Vd: Innova)
  COUPE
}

// --- HỆ THỐNG QUẢN LÝ KHÁCH HÀNG (LEADS) ---

model Customer {
  id       String       @id @default(cuid())
  fullName String // Tên khách hàng
  phone    String // Số điện thoại khách
  type     ReferralType @default(SELL) // Nhu cầu: Bán/Mua/Định giá
  status   LeadStatus   @default(NEW) // Trạng thái xử lý

  // --- CÁC TRƯỜNG BỔ SUNG TỪ GIAO DIỆN ---
  carYear       String? // Loại xe (Vd: Vios, Fortuner...)
  licensePlate  String? // Biển số xe (Dành cho Bán xe & Định giá)
  budget        String? // Ngân sách (Dành cho Mua xe)
  expectedPrice String? // Giá mong muốn (Dành cho Định giá)

  assignedAt     DateTime? // Thời điểm bàn giao khách cho NV
  firstContactAt DateTime? // Thời điểm thực hiện cuộc gọi/liên hệ đầu tiên
  lastContactAt  DateTime? // Lần liên hệ gần nhất
  nextContactAt  DateTime? // Lần liên hệ tiếp theo (Hẹn gọi lại)
  urgencyLevel   UrgencyType? // Lưu trạng thái Hot/Warm/Cool lúc mới tiếp cận

  isPublished Boolean   @default(false) // Admin tích vào đây xe mới hiện lên web
  displayDate DateTime? // Ngày bắt đầu cho hiện showroom (để sort xe mới về)

  // Lưu trữ link hình ảnh (sau khi upload lên Cloudinary/S3)
  carImages         String? @db.Text // JSON string hoặc danh sách link ảnh xe
  registrationImage String? @db.Text // Ảnh đăng kiểm
  idCardFront       String? @db.Text // Ảnh giấy tờ mặt trước
  idCardBack        String? @db.Text // Ảnh giấy tờ mặt sau

  carModelId String?
  carModel   CarModel? @relation(fields: [carModelId], references: [id])

  note String? @db.Text // Ghi chú chi tiết thêm
  // ---------------------------------------

  // Người giới thiệu khách (Referrer)
  referrerId String
  referrer   User   @relation("CreatedReferrals", fields: [referrerId], references: [id])

  // Nhân viên được giao chăm sóc
  assignedToId String?
  assignedTo   User?   @relation("AssignedLeads", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activities        LeadActivity[]
  carOwnerHistories CarOwnerHistory[]

  // Thêm index cho status để tăng tốc độ truy vấn khi lọc khách hàng
  @@index([status])
  @@index([referrerId])
  @@index([assignedToId])
}

model LeadActivity {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  status LeadStatus // Trạng thái tại thời điểm cập nhật

  // Liên kết đến lý do mẫu từ Admin
  reasonId String?
  reason   LeadReason? @relation(fields: [reasonId], references: [id])

  // Ghi chú thêm của nhân viên (không bắt buộc)
  note String? @db.Text

  createdById String
  user        User     @relation(fields: [createdById], references: [id]) // Tên quan hệ ở đây
  createdAt   DateTime @default(now())

  @@index([customerId])
  @@index([reasonId])
}

model LeadReason {
  id         String         @id @default(cuid())
  content    String         @unique // Nội dung lý do (VD: Khách chê giá thu thấp)
  type       LeadStatus // Thuộc nhóm trạng thái nào (LOSE, FROZEN, PENDING_VIEW)
  active     Boolean        @default(true) // Cho phép sử dụng hay ẩn đi
  activities LeadActivity[] // Quan hệ ngược lại để truy xuất thống kê
  createdAt  DateTime       @default(now())
}

// --- ENUMS (DANH MỤC CỐ ĐỊNH) ---

enum Role {
  ADMIN // Quản trị hệ thống
  MANAGER // Quản lý chi nhánh/phòng ban
  PURCHASE_STAFF // Nhân viên thu mua (Định giá/Mua xe)
  SALES_STAFF // Nhân viên kinh doanh (Bán xe)
  REFERRER // Người giới thiệu (Cộng tác viên/NV các phòng khác)
}

enum ReferralType {
  SELL // Khách hàng muốn bán/đổi xe
  BUY // Khách hàng muốn tìm mua xe cũ
  VALUATION // Khách hàng chỉ muốn định giá xe
}

enum LeadStatus {
  NEW // Mới tiếp nhận từ người giới thiệu
  ASSIGNED // Đã phân bổ cho nhân viên chăm sóc
  CONTACTED // Đã liên hệ trao đổi với khách
  DEAL_DONE // Đã giao dịch thành công (Mua hoặc Bán)
  CANCELLED // Khách không còn nhu cầu hoặc sai thông tin
  PENDING_DEAL_APPROVAL // Chờ duyệt Thu mua/Bán thành công
  PENDING_LOSE_APPROVAL // Chờ duyệt Thất bại

  LOSE // Thất bại hoàn toàn
  FROZEN // Đóng băng (Tạm dừng chăm sóc)
  PENDING_VIEW // Nguyên nhân chưa xem xe được
}

enum CarStatus {
  PENDING // Đang chờ kiểm tra/định giá
  PURCHASE_FAILED // Không mua được xe
  REFURBISHING // Đang trong quá trình làm đẹp (Maru-Kuri)
  READY_FOR_SALE // Đã sẵn sàng trưng bày bán
  BOOKED // Khách đã đặt cọc
  SOLD // Đã bàn giao xe cho khách
}

model CarOwnerHistory {
  id         String   @id @default(cuid())
  carId      String
  car        Car      @relation(fields: [carId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  type       String // "PURCHASE" (Mua vào) hoặc "SALE" (Bán ra)
  contractNo String?
  price      Decimal  @db.Decimal(15, 2)
  date       DateTime @default(now())
  note       String?
}
