// ==========================================
// 1. CẤU HÌNH HỆ THỐNG
// ==========================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model LeadSetting {
  id             String   @id @default("lead_config")
  hotDays        Int      @default(3)
  warmDays       Int      @default(7)
  updatedAt      DateTime @updatedAt
  maxLateMinutes Int      @default(30)
}

// ==========================================
// 2. CƠ CẤU TỔ CHỨC
// ==========================================
model Branch {
  id             String          @id @default(cuid())
  name           String          @unique
  address        String
  cars           Car[]
  users          User[]
  salesSchedules SalesSchedule[]
  customers      Customer[]      @relation("BranchCustomers")
}

model Department {
  id        String     @id @default(cuid())
  name      String     @unique
  positions Position[]
  users     User[]
  createdAt DateTime   @default(now())
}

model Position {
  id           String     @id @default(cuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  users        User[]

  @@unique([name, departmentId])
}

model CarModel {
  id        String     @id @default(cuid())
  name      String     @unique
  grade     String?
  customers Customer[] @relation("InterestedModel")
  cars      Car[]
  leadCars  LeadCar[]
}

// ==========================================
// 3. TÀI KHOẢN NGƯỜI DÙNG
// ==========================================
model User {
  id       String     @id @default(cuid())
  username String     @unique
  fullName String?
  email    String     @unique
  password String
  phone    String?
  role     Role       @default(REFERRER)
  active   Boolean    @default(true)
  status   UserStatus @default(PENDING)

  branchId     String?
  branch       Branch?     @relation(fields: [branchId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  positionId   String?
  position     Position?   @relation(fields: [positionId], references: [id])

  extension       String?
  extensionPwd    String?
  isGlobalManager Boolean @default(false)

  // --- QUAN HỆ NGHIỆP VỤ XE ---
  purchases      Car[] @relation("Purchaser")
  negotiatedCars Car[] @relation("PriceNegotiator")
  referrals      Car[] @relation("Referrer")
  managedCars    Car[] @relation("CarManager")
  soldCars       Car[] @relation("CarSeller") // THÊM DÒNG NÀY ĐỂ LIÊN KẾT VỚI XE ĐÃ BÁN

  // --- QUAN HỆ KHÁCH HÀNG ---
  createdReferrals Customer[]      @relation("CreatedReferrals")
  assignedLeads    Customer[]      @relation("AssignedLeads")
  inspectedLeads   Customer[]      @relation("Inspector")
  leadActivities   LeadActivity[]
  salesSchedules   SalesSchedule[]
  tasks            Task[]          @relation("UserTasks")

  lastAssignedAt DateTime? @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  cars           Car[]

  @@index([branchId])
}

// ==========================================
// 4. QUẢN LÝ KHÁCH HÀNG (LEADS)
// ==========================================
model Customer {
  id     String       @id @default(cuid())
  status LeadStatus   @default(NEW)
  type   ReferralType @default(SELL)

  referrerId   String
  referrer     User     @relation("CreatedReferrals", fields: [referrerId], references: [id])
  referralDate DateTime @default(now())

  assignedToId String?
  assignedTo   User?     @relation("AssignedLeads", fields: [assignedToId], references: [id])
  assignedAt   DateTime?

  branchId String?
  branch   Branch? @relation("BranchCustomers", fields: [branchId], references: [id])

  fullName String
  phone    String
  province String?
  address  String? @db.Text

  firstContactAt DateTime? // THÊM DÒNG NÀY

  carModelId    String?
  carModel      CarModel? @relation("InterestedModel", fields: [carModelId], references: [id])
  licensePlate  String?
  carYear       String?
  expectedPrice String?
  budget        String?
  note          String?   @db.Text

  inspectorId     String?
  inspector       User?     @relation("Inspector", fields: [inspectorId], references: [id])
  inspectDate     DateTime?
  inspectLocation String?
  inspectStatus   String?
  inspectDoneDate DateTime?
  notSeenReason   String?   @db.Text

  urgencyLevel      UrgencyType?
  lastContactAt     DateTime?
  lastContactResult String?      @db.Text
  contactCount      Int          @default(0)
  nextContactAt     DateTime?
  nextContactNote   String?      @db.Text

  carImages Json?
  documents Json?

  leadCar        LeadCar?
  activities     LeadActivity[]
  ownerHistories CarOwnerHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tasks     Task[]

  @@index([status])
  @@index([phone])
}

// ==========================================
// 5. CHI TIẾT XE GIÁM ĐỊNH
// ==========================================
model LeadCar {
  id         String   @id @default(cuid())
  customerId String   @unique
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  modelName             String?
  grade                 String?
  color                 String?
  interiorColor         String?
  year                  Int?
  vin                   String?
  engineNumber          String?
  licensePlate          String?
  odo                   Int?
  description           String?       @db.Text
  transmission          Transmission? @default(AUTOMATIC)
  fuelType              FuelType?     @default(GASOLINE)
  driveTrain            String?
  engineSize            String?
  carType               CarType?
  origin                OriginType?   @default(VN)
  ownerType             OwnerType?    @default(PERSONAL)
  seats                 Int?          @default(5)
  features              Json?
  registrationDeadline  DateTime?
  insuranceTNDS         Boolean       @default(false)
  insuranceTNDSDeadline DateTime?
  insuranceVC           Boolean       @default(false)
  insuranceVCCorp       String?
  insuranceVCDeadline   DateTime?
  insuranceDeadline     DateTime?

  tSurePrice    Decimal? @db.Decimal(15, 2)
  expectedPrice Decimal? @db.Decimal(15, 2)
  finalPrice    Decimal? @db.Decimal(15, 2)
  tradeInModel  String?

  carModelId String?
  carModel   CarModel? @relation(fields: [carModelId], references: [id])

  images    Json?
  note      String?  @db.Text
  updatedAt DateTime @updatedAt

  @@index([vin])
}

// ==========================================
// 6. KHO XE THỰC TẾ
// ==========================================
model Car {
  id        String @id @default(cuid())
  stockCode String @unique
  modelName String
  vin       String

  engineNumber String?
  licensePlate String?
  year         Int
  odo          Int

  transmission  Transmission @default(AUTOMATIC)
  fuelType      FuelType     @default(GASOLINE)
  carType       CarType      @default(SUV)
  origin        OriginType   @default(VN)
  ownerType     OwnerType    @default(PERSONAL)
  color         String?
  interiorColor String?
  seats         Int          @default(5)
  engineSize    String?
  driveTrain    String?

  registrationDeadline  DateTime?
  insuranceTNDS         Boolean   @default(false)
  insuranceTNDSDeadline DateTime?
  insuranceVC           Boolean   @default(false)
  insuranceVCCorp       String?
  insuranceVCDeadline   DateTime?
  insuranceDeadline     DateTime?

  images        Json?
  videoUrl      String?
  features      Json?
  description   String?   @db.Text
  isPublished   Boolean   @default(false)
  isPromoted    Boolean   @default(false)
  promotionNote String?
  displayDate   DateTime?

  status       CarStatus @default(PENDING)
  costPrice    Decimal?  @db.Decimal(15, 2)
  sellingPrice Decimal?  @db.Decimal(15, 2)
  purchasedAt  DateTime?

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  purchaserId String?
  purchaser   User?   @relation("Purchaser", fields: [purchaserId], references: [id])

  referrerId String
  referrer   User   @relation("Referrer", fields: [referrerId], references: [id])

  managedById String?
  managedBy   User?   @relation("CarManager", fields: [managedById], references: [id])

  priceNegotiatorId String?
  priceNegotiator   User?   @relation("PriceNegotiator", fields: [priceNegotiatorId], references: [id])

  carModelId String?
  carModel   CarModel? @relation(fields: [carModelId], references: [id])

  ownerHistory CarOwnerHistory[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // --- QUAN HỆ BÁN HÀNG (QUAN TRỌNG NHẤT) ---
  soldAt   DateTime? // Ngày giờ chính thức xuất kho bán
  soldById String? // ID nhân viên chốt sale
  soldBy   User?     @relation("CarSeller", fields: [soldById], references: [id])

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([soldById]) // Thêm index để báo cáo chạy nhanh hơn
  @@index([vin])
  @@index([stockCode])
}

// ==========================================
// 7. NHẬT KÝ & LỊCH SỬ
// ==========================================
model LeadActivity {
  id          String      @id @default(cuid())
  customerId  String
  customer    Customer    @relation(fields: [customerId], references: [id])
  status      LeadStatus
  note        String?     @db.Text
  lateMinutes Int?        @default(0) // Số phút trễ so với quy định/lịch hẹn
  isLate      Boolean?    @default(false) // Đánh dấu nhanh bản ghi này có bị trễ hay không
  // Thêm lại 2 dòng này để giữ dữ liệu
  reasonId    String?
  reason      LeadReason? @relation(fields: [reasonId], references: [id])

  createdById String
  user        User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
}

model LeadReason {
  id         String         @id @default(cuid())
  content    String         @unique
  type       LeadStatus
  active     Boolean        @default(true)
  activities LeadActivity[]
}

model CarOwnerHistory {
  id         String   @id @default(cuid())
  carId      String
  car        Car      @relation(fields: [carId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  type       String
  price      Decimal  @db.Decimal(15, 2)
  date       DateTime @default(now())
  contractNo String?
  note       String?  @db.Text
}

model SalesSchedule {
  id        String   @id @default(cuid())
  date      DateTime
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([date, branchId])
}

model Task {
  id      String  @id @default(cuid())
  title   String
  content String? @db.Text

  // Thời gian
  scheduledAt DateTime // Thời gian Sale hẹn khách
  deadlineAt  DateTime // Thời gian Admin quy định phải hoàn thành (Deadline)
  completedAt DateTime? // Thời gian thực tế bấm nút "Hoàn thành"

  status      TaskStatus @default(PENDING)
  isLate      Boolean    @default(false)
  lateMinutes Int        @default(0)

  // Quan hệ
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  assigneeId String
  assignee   User     @relation("UserTasks", fields: [assigneeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// 8. DANH MỤC CỐ ĐỊNH (ENUMS)
// ==========================================
enum TaskStatus {
  PENDING
  COMPLETED
  CANCELLED
  EXPIRED // Quá hạn mà chưa làm
}

enum UserStatus {
  PENDING // Đang chờ duyệt
  APPROVED // Đã duyệt (Đang hoạt động)
  REJECTED // Đã từ chối
  BANNED // Đã khóa
}

enum Role {
  ADMIN
  MANAGER
  PURCHASE_STAFF
  SALES_STAFF
  REFERRER
}

enum ReferralType {
  SELL
  BUY
  VALUATION
  SELL_TRADE_NEW
  SELL_TRADE_USED
}

enum LeadStatus {
  NEW
  ASSIGNED
  FOLLOW_UP
  CONTACTED
  INSPECTING
  PENDING_DEAL_APPROVAL
  DEAL_DONE
  CANCELLED
  LOSE
  FROZEN
  PENDING_LOSE_APPROVAL
  REJECTED_APPROVAL
  PENDING_VIEW
}

enum CarStatus {
  NEW
  PENDING
  REFURBISHING
  READY_FOR_SALE
  BOOKED
  SOLD
}

enum Transmission {
  MANUAL
  AUTOMATIC
  CVT
}

enum FuelType {
  GASOLINE
  DIESEL
  HYBRID
  ELECTRIC
}

enum CarType {
  SEDAN
  SUV
  HATCHBACK
  PICKUP
  MPV
  COUPE
}

enum UrgencyType {
  HOT
  WARM
  COOL
}

enum OriginType {
  VN
  TH
  ID
  OTHER
}

enum OwnerType {
  PERSONAL
  AUTHORIZATION_L1
  AUTHORIZATION_L2
  COMPANY_VAT
}
